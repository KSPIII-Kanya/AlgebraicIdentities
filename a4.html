<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanya Sampoorna Project - (a + b + c)² Simulation</title>
    <style>
        /* * =================================
         * GLOBAL STYLES
         * =================================
         */
        :root {
            --header-height: 120px;
            --footer-height: 50px;
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --color-primary: #005A9C;
            --color-secondary: #00A9E0;
            --color-accent: #FFC425;
            --color-success: #4CAF50;
            --color-error: #F44336;
            --color-text-light: #FFFFFF;
            --color-text-dark: #333333;
            --color-bg-light: #F4F9FF;
            --color-bg-white: #FFFFFF;
            --color-border: #DDDDDD;

            /* Simulation Colors */
            --color-a-sq: #2E86C1;
            /* Blue */
            --color-b-sq: #E74C3C;
            /* Red */
            --color-c-sq: #2ECC71;
            /* Green */
            --color-ab: #F39C12;
            /* Orange */
            --color-bc: #9B59B6;
            /* Purple */
            --color-ac: #1ABC9C;
            /* Teal */
            --color-guide: rgba(255, 196, 37, 0.7);
            /* Yellow */
            --color-guide-border: #FFC425;
            --color-highlight: rgba(76, 175, 80, 0.5);
            /* Semi-transparent Green */
            --color-highlight-border: #4CAF50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            font-family: var(--font-sans);
            background-color: var(--color-bg-light);
            color: var(--color-text-dark);
            overflow: hidden;
            /* Prevents double scrollbars */
        }

        /* * =================================
         * LAYOUT (HEADER, MAIN, FOOTER)
         * =================================
         */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .header {
            width: 100%;
            height: var(--header-height);
            background-color: var(--color-primary);
            color: var(--color-text-light);
            text-align: center;
            padding: 1rem;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.4;
        }

        .header h1 {
            font-size: clamp(1.2rem, 3.5vw, 1.8rem);
            margin: 0;
        }

        .header p {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            margin: 0;
        }

        .main-content {
            width: 100%;
            /* This is the main scrolling area */
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
            display: block;
            /* Default state */
        }

        .footer {
            width: 100%;
            height: var(--footer-height);
            background-color: var(--color-primary);
            color: var(--color-text-light);
            text-align: center;
            padding: 1rem;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }

        .footer p {
            margin: 0;
        }

        /* * =================================
         * SIMULATION VIEW
         * =================================
         */
        #simulation-view {
            width: 100%;
            height: 100%;
            display: none;
            /* Hidden by default, shown by JS */
            flex-direction: column;
            overflow: hidden;
            /* Prevent internal scrolling */
        }

        .sim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            /* Changed from 'center' for multi-line title */
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-border);
            flex-shrink: 0;
            gap: 1rem;
            /* Added gap for better spacing */
        }

        .sim-header-title {
            flex-grow: 1;
        }

        .sim-header-title h2 {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            color: var(--color-primary);
            margin: 0;
        }

        .sim-header-title p {
            font-size: 1rem;
            font-weight: 500;
            font-family: monospace;
            color: var(--color-text-dark);
            margin: 0;
        }

        .sim-header-buttons {
            display: flex;
            flex-shrink: 0;
        }

        .sim-button {
            font-size: 1rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            color: var(--color-text-light);
            margin-left: 0.5rem;
        }

        .sim-button.back {
            background-color: var(--color-secondary);
        }

        .sim-button.back:hover {
            background-color: #008fbf;
        }

        .sim-button.reset {
            background-color: var(--color-error);
        }

        .sim-button.reset:hover {
            background-color: #d32f2f;
        }

        .sim-button.next {
            background-color: var(--color-success);
        }

        .sim-button.next:hover {
            background-color: #43A047;
        }

        .sim-body {
            display: flex;
            flex-grow: 1;
            width: 100%;
            height: 100%;
            /* Fills remaining space */
            overflow: hidden;
            /* Prevents scrollbars */
            gap: 1.5rem;
            padding-top: 1rem;
            flex-wrap: wrap;
            /* Allows sidebar to wrap on small screens */
        }

        .sim-canvas-container {
            flex-grow: 1;
            /* Takes up available space */
            flex-basis: 300px;
            /* Minimum width */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            /* Ensures canvas is visible */
            height: 100%;
        }

        #simulation-canvas {
            border: 1px solid var(--color-border);
            background-color: var(--color-bg-white);
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 1.6 / 1;
            /* Wider than tall, good for side-by-side */
            cursor: pointer;
        }

        .sim-sidebar {
            flex-basis: 300px;
            /* Initial width */
            flex-grow: 0.5;
            flex-shrink: 0;
            padding: 1.5rem;
            background-color: var(--color-bg-white);
            border-radius: 12px;
            border: 1px solid var(--color-border);
            overflow-y: auto;
            /* Scrollable if content overflows */
        }

        .sim-sidebar h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--color-primary);
        }

        .sim-sidebar p,
        .sim-sidebar li {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
            /* Consistent spacing */
        }

        .sim-sidebar ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
            /* Space after list */
        }

        .current-step-instruction {
            font-weight: bold;
            color: var(--color-primary);
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #e7f3fe;
            border-left: 5px solid var(--color-primary);
            border-radius: 4px;
        }

        /* Responsive adjustments for simulation view */
        @media (max-width: 768px) {
            .sim-header {
                flex-direction: column;
                align-items: stretch;
            }

            .sim-header-buttons {
                justify-content: flex-end;
                margin-top: 0.5rem;
            }

            .sim-body {
                flex-direction: column;
                overflow-y: auto;
                /* Allow body to scroll */
                height: auto;
                /* Remove fixed height */
            }

            .sim-canvas-container {
                height: auto;
                /* Adjust height */
                min-height: 300px;
                /* Keep a min height */
                flex-grow: 0;
                /* Don't grow */
                width: 100%;
                /* Full width */
            }

            #simulation-canvas {
                width: 100%;
                height: auto;
                aspect-ratio: 1.2 / 1;
                /* More square-ish */
            }

            .sim-sidebar {
                flex-basis: auto;
                /* Auto height */
                width: 100%;
                /* Full width */
                margin-top: 1rem;
            }

            .sim-header h2 {
                font-size: 1.1rem;
            }

            .sim-button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- 1. Header -->
        <header class="header">
            <h1>Kanya Sampoorna Project 3.0 / Kanya Girls Education Project</h1>
            <p><strong>The project is supported by TITAN and implemented by KALIKE</strong></p>
            <p>AI-powered Math Simulation for fun, visual, and interactive learning of Algebraic Identities</p>
        </header>

        <!-- 2. Main Content (Simulation) -->
        <main class="main-content" id="main-content-area">

            <!-- Simulation View (Visible by default in this version) -->
            <div id="simulation-view">
                <div class="sim-header">
                    <div class="sim-header-title">
                        <h2 id="sim-title">Simulation Title</h2>
                        <p id="sim-formula"></p>
                    </div>
                    <div class="sim-header-buttons">
                        <button id="next-sim-button" class="sim-button next">Next</button>
                        <button id="reset-sim-button" class="sim-button reset">Reset</button>
                        <button id="back-to-menu-button" class="sim-button back">Back to Menu</button>
                    </div>
                </div>
                <div class="sim-body">
                    <div class="sim-canvas-container">
                        <canvas id="simulation-canvas"></canvas>
                    </div>
                    <aside class="sim-sidebar">
                        <h3 id="sim-instructions-title">How to Play</h3>
                        <div id="sim-instructions-content">
                            <!-- Instructions will be dynamically inserted here -->
                        </div>
                        <div id="current-step-text" class="current-step-instruction">
                            <!-- Current instruction appears here -->
                        </div>
                    </aside>
                </div>
            </div>
        </main>

        <!-- 4. Footer -->
        <footer class="footer">
            <p><strong>Powered by AI and created by Kalike: An initiative of Tata Trusts.</strong></p>
        </footer>
    </div>

    <script>
        // ========================================================================
        // GLOBAL STATE & DATA
        // ========================================================================

        // DOM Element references (DECLARED here)
        let simView, mainContentArea, backButton, resetButton, nextButton;
        let simTitle, simFormula, simInstructionsTitle, simInstructionsContent, currentStepText;
        let canvas, ctx;

        // Global simulation state
        let currentSimulation = null; // Will hold the active simulation object

        // ========================================================================
        // INITIALIZATION
        // ========================================================================

        /**
         * Initializes the application on window load.
         * This version skips the menu and loads the (a + b + c)² sim directly.
         */
        window.onload = () => {
            // ASSIGN DOM elements now that the DOM is loaded
            simView = document.getElementById('simulation-view');
            mainContentArea = document.getElementById('main-content-area');
            backButton = document.getElementById('back-to-menu-button');
            resetButton = document.getElementById('reset-sim-button');
            nextButton = document.getElementById('next-sim-button');
            simTitle = document.getElementById('sim-title');
            simFormula = document.getElementById('sim-formula');
            simInstructionsTitle = document.getElementById('sim-instructions-title');
            simInstructionsContent = document.getElementById('sim-instructions-content');
            currentStepText = document.getElementById('current-step-text');
            canvas = document.getElementById('simulation-canvas');
            ctx = canvas.getContext('2d');

            // --- Load the (a + b + c)² Simulation Directly ---

            // 1. Set titles and show menu button
            simTitle.textContent = 'Square of a Trinomial';
            simFormula.textContent = '(a + b + c)² = a² + b² + c² + 2ab + 2bc + 2ca';

            // 2. Instantiate the simulation
            currentSimulation = new Sim_A_Plus_B_Plus_C_Sq(canvas, ctx);

            // 3. Set instructions
            simInstructionsTitle.textContent = currentSimulation.instructions.title;
            simInstructionsContent.innerHTML = currentSimulation.instructions.steps;

            // 4. Configure buttons for this "puzzle" type sim
            resetButton.style.display = 'inline-block';
            nextButton.style.display = 'none'; // Hide next for puzzle/interactive
            canvas.style.cursor = 'pointer';
            currentStepText.style.display = 'block'; // Show step text area

            // 5. Show the simulation view
            simView.style.display = 'flex';
            mainContentArea.style.overflow = 'hidden'; // Disable scrolling for sim view

            // 6. Initialize and draw the simulation
            currentSimulation.init();
            currentSimulation.draw();

            // 7. Add event listeners
            resetButton.addEventListener('click', resetCurrentSimulation);

            backButton.addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            window.addEventListener('resize', () => {
                if (currentSimulation) {
                    currentSimulation.resize();
                    currentSimulation.draw();
                }
            });
        };

        /**
         * Resets the currently active simulation.
         */
        function resetCurrentSimulation() {
            if (currentSimulation) {
                currentSimulation.init();
                currentSimulation.draw();
            }
        }

        // ========================================================================
        // CLICK HANDLING UTILITY
        // ========================================================================

        /**
         * Gets the mouse/touch coordinates relative to the canvas.
         * @param {PointerEvent} event - The 'pointerdown' event.
         * @returns {{x: number, y: number}} - The (x, y) coordinates on the canvas.
         */
        function getCanvasCoords(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = event.clientX;
            const clientY = event.clientY;
            const canvasX = (clientX - rect.left) * scaleX;
            const canvasY = (clientY - rect.top) * scaleY;
            return {
                x: canvasX,
                y: canvasY
            };
        }

        /**
         * Checks if a point (x, y) is inside a rectangular shape.
         * @param {{x: number, y: number}} point - The point to check.
         * @param {{x: number, y: number, w: number, h: number}} rect - The rectangle.
         * @param {number} [tolerance=0] - A click tolerance buffer.
         * @returns {boolean} - True if the point is inside.
         */
        function isPointInRect(point, rect, tolerance = 0) {
            return (
                point.x >= rect.x - tolerance &&
                point.x <= rect.x + rect.w + tolerance &&
                point.y >= rect.y - tolerance &&
                point.y <= rect.y + rect.h + tolerance
            );
        }

        // ========================================================================
        // BASE SIMULATION CLASS
        // ========================================================================
        /**
         * Base class for simulations.
         */
        class Simulation {
            constructor(canvas, ctx) {
                this.canvas = canvas;
                this.ctx = ctx;
                this.padding = 20; // Base padding
                this.clickTolerance = 10; // 10px tolerance for easier clicking
                this.state = {}; // Holds the simulation-specific state
                this.instructions = {
                    title: "Instructions",
                    steps: "<p>Click a simulation to start.</p>"
                };
                this.fontSans = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';

                // Bind the event listener
                this.handlePointerDown = this.handlePointerDown.bind(this);
                this.canvas.addEventListener('pointerdown', this.handlePointerDown);
            }

            // Abstract methods to be overridden by child classes
            init() {
                throw new Error("Must override init()");
            }
            draw() {
                throw new Error("Must override draw()");
            }
            onCanvasClick(x, y) { /* Optional to implement */ }

            /**
             * Handles the 'pointerdown' event, gets coordinates, and calls the child's click handler.
             */
            handlePointerDown(event) {
                event.preventDefault(); // Prevent unwanted scrolling/zooming
                const coords = getCanvasCoords(event);
                this.onCanvasClick(coords.x, coords.y); // Call child's click handler
            }

            /**
             * Removes event listeners.
             */
            destroy() {
                this.canvas.removeEventListener('pointerdown', this.handlePointerDown);
            }

            /**
             * Resizes the canvas element to fit its container while maintaining aspect ratio.
             */
            resize() {
                const container = this.canvas.parentElement;
                if (!container) return; // Guard against no parent

                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;

                if (containerWidth === 0 || containerHeight === 0) return; // Guard against 0 size

                const cssAspectRatio = window.getComputedStyle(this.canvas).aspectRatio;
                let [arW, arH] = cssAspectRatio.split(' / ').map(Number);
                if (isNaN(arW) || isNaN(arH) || arH === 0) {
                    arW = 1.6;
                    arH = 1;
                }
                const ratio = arW / arH;

                let newWidth, newHeight;
                if (containerWidth / containerHeight > ratio) {
                    newHeight = containerHeight;
                    newWidth = newHeight * ratio;
                } else {
                    newWidth = containerWidth;
                    newHeight = newWidth / ratio;
                }

                // Set a fixed internal resolution
                this.canvas.width = 800;
                this.canvas.height = 500;
                // Set the display size
                this.canvas.style.width = `${newWidth}px`;
                this.canvas.style.height = `${newHeight}px`;
            }

            /**
             * Clears the entire canvas.
             */
            clearCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            /**
             * Draws a styled piece (rectangle).
             */
            drawPiece(piece, isSelected = false) {
                this.ctx.fillStyle = piece.color;
                this.ctx.fillRect(piece.x, piece.y, piece.w, piece.h);

                if (isSelected) {
                    this.ctx.strokeStyle = '#FFC425';
                    this.ctx.lineWidth = 4;
                    this.ctx.strokeRect(piece.x, piece.y, piece.w, piece.h);
                }

                // --- START EDIT ---
                // Determine text color based on piece label for better contrast
                const isDarkBg = ['b²', 'c²', 'bc', 'ac'].some(label => piece.label.includes(label));
                this.ctx.fillStyle = isDarkBg ? 'white' : 'black';

                // Adjust font size based on piece width to prevent overflow
                let fontSize;
                if (['ac', 'bc', 'c²'].includes(piece.label)) {
                    // Use a larger fraction of the width for these specific labels
                    fontSize = Math.min(30, Math.max(12, piece.w / 1.8));
                } else {
                    // Original logic for other labels
                    fontSize = Math.min(30, Math.max(12, piece.w / 3));
                }
                // --- END EDIT ---

                this.ctx.font = `bold ${fontSize}px ${this.fontSans}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(piece.label, piece.x + piece.w / 2, piece.y + piece.h / 2);
            }


            /**
             * Draws a dashed guide box.
             */
            drawGuide(zone) {
                this.ctx.strokeStyle = '#FFC425';
                this.ctx.lineWidth = 3;
                this.ctx.setLineDash([10, 10]);
                this.ctx.strokeRect(zone.x, zone.y, zone.w, zone.h);
                this.ctx.setLineDash([]); // Reset line dash
            }
            /**
             * Draws a highlight box for interactive steps.
             */
            drawHighlight(zone) {
                this.ctx.fillStyle = 'rgba(76, 175, 80, 0.3)'; // Semi-transparent Green fill
                this.ctx.fillRect(zone.x, zone.y, zone.w, zone.h);
                this.ctx.strokeStyle = '#4CAF50'; // Solid Green border
                this.ctx.lineWidth = 3;
                this.ctx.strokeRect(zone.x, zone.y, zone.w, zone.h);
            }

            /**
             * Draws a dashed highlight line.
             */
            drawHighlightLine(line) {
                this.ctx.strokeStyle = '#FFC425'; // Use the yellow guide color
                this.ctx.lineWidth = 4;
                this.ctx.setLineDash([10, 10]);
                this.ctx.beginPath();
                this.ctx.moveTo(line.x1, line.y1);
                this.ctx.lineTo(line.x2, line.y2);
                this.ctx.stroke();
                this.ctx.setLineDash([]); // Reset line dash
            }


            /**
             * Draws feedback text on the canvas.
             */
            drawFeedback(text, color, yPos) {
                this.ctx.fillStyle = color;
                this.ctx.font = `bold 24px ${this.fontSans}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(text, this.canvas.width / 2, yPos);
            }
        }

        // ========================================================================
        // SIMULATION: (a + b + c)² - PUZZLE
        // ========================================================================
        class Sim_A_Plus_B_Plus_C_Sq extends Simulation {
            constructor(canvas, ctx) {
                super(canvas, ctx);
                this.instructions = {
                    title: "Prove: (a + b + c)²",
                    steps: `
                        <ol>
                            <li>The empty frame is a square with side (a + b + c).</li>
                            <li>Your goal is to fill this frame using all 9 pieces from the right.</li>
                            <li>Click a piece, then click its correct spot in the frame.</li>
                        </ol>
                    `
                };
                currentStepText.textContent = "Click a piece on the right to select it."; // Initial step
            }

            init() {
                this.resize();
                this.a = 150;
                this.b = 100;
                this.c = 50;
                this.totalSize = this.a + this.b + this.c;
                this.frame = {
                    x: this.padding + 20,
                    y: this.padding + 50
                };
                this.bank = {
                    x: this.frame.x + this.totalSize + 60,
                    y: this.frame.y
                };

                this.state = {
                    pieces: [
                        // Column 1
                        { id: 'a_sq', x: this.bank.x, y: this.bank.y, w: this.a, h: this.a, color: '#2E86C1', label: 'a²' },
                        { id: 'ab_2', x: this.bank.x, y: this.bank.y + this.a + 10, w: this.a, h: this.b, color: '#F39C12', label: 'ab' }, // wide
                        { id: 'ac_2', x: this.bank.x, y: this.bank.y + this.a + 10 + this.b + 10, w: this.a, h: this.c, color: '#1ABC9C', label: 'ac' }, // wide
                        // Column 2
                        { id: 'ab_1', x: this.bank.x + this.a + 10, y: this.bank.y, w: this.b, h: this.a, color: '#F39C12', label: 'ab' }, // tall
                        { id: 'b_sq', x: this.bank.x + this.a + 10, y: this.bank.y + this.a + 10, w: this.b, h: this.b, color: '#E74C3C', label: 'b²' },
                        { id: 'bc_2', x: this.bank.x + this.a + 10, y: this.bank.y + this.a + 10 + this.b + 10, w: this.b, h: this.c, color: '#9B59B6', label: 'bc' }, // wide
                        // Column 3
                        { id: 'ac_1', x: this.bank.x + this.a + 10 + this.b + 10, y: this.bank.y, w: this.c, h: this.a, color: '#1ABC9C', label: 'ac' }, // tall
                        { id: 'bc_1', x: this.bank.x + this.a + 10 + this.b + 10, y: this.bank.y + this.a + 10, w: this.c, h: this.b, color: '#9B59B6', label: 'bc' }, // tall
                        { id: 'c_sq', x: this.bank.x + this.a + 10 + this.b + 10, y: this.bank.y + this.a + 10 + this.b + 10, w: this.c, h: this.c, color: '#2ECC71', label: 'c²' },
                    ],
                    zones: [{
                        id: 'a_sq',
                        x: this.frame.x,
                        y: this.frame.y,
                        w: this.a,
                        h: this.a,
                        placed: false
                    }, {
                        id: 'ab_1',
                        x: this.frame.x + this.a,
                        y: this.frame.y,
                        w: this.b,
                        h: this.a,
                        placed: false
                    }, {
                        id: 'ac_1',
                        x: this.frame.x + this.a + this.b,
                        y: this.frame.y,
                        w: this.c,
                        h: this.a,
                        placed: false
                    }, {
                        id: 'ab_2',
                        x: this.frame.x,
                        y: this.frame.y + this.a,
                        w: this.a,
                        h: this.b,
                        placed: false
                    }, {
                        id: 'b_sq',
                        x: this.frame.x + this.a,
                        y: this.frame.y + this.a,
                        w: this.b,
                        h: this.b,
                        placed: false
                    }, {
                        id: 'bc_1',
                        x: this.frame.x + this.a + this.b,
                        y: this.frame.y + this.a,
                        w: this.c,
                        h: this.b,
                        placed: false
                    }, {
                        id: 'ac_2',
                        x: this.frame.x,
                        y: this.frame.y + this.a + this.b,
                        w: this.a,
                        h: this.c,
                        placed: false
                    }, {
                        id: 'bc_2',
                        x: this.frame.x + this.a,
                        y: this.frame.y + this.a + this.b,
                        w: this.b,
                        h: this.c,
                        placed: false
                    }, {
                        id: 'c_sq',
                        x: this.frame.x + this.a + this.b,
                        y: this.frame.y + this.a + this.b,
                        w: this.c,
                        h: this.c,
                        placed: false
                    }, ],
                    selectedPieceId: null,
                    feedback: {
                        message: "", // Feedback now shown below canvas
                        color: '#333333'
                    },
                    completed: false
                };
                currentStepText.textContent = "Click a piece on the right to select it."; // Reset step
            }

            draw() {
                this.clearCanvas();
                const {
                    pieces,
                    zones,
                    selectedPieceId,
                    feedback,
                    completed
                } = this.state;

                // Frame
                this.ctx.strokeStyle = '#333333';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(this.frame.x, this.frame.y, this.totalSize, this.totalSize);

                // (a+b+c) label
                this.ctx.fillStyle = '#333333';
                this.ctx.font = `bold 20px ${this.fontSans}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText("(a + b + c)", this.frame.x + this.totalSize / 2, this.frame.y - 20);
                this.ctx.save();
                this.ctx.translate(this.frame.x - 20, this.frame.y + this.totalSize / 2);
                this.ctx.rotate(-Math.PI / 2);
                this.ctx.fillText("(a + b + c)", 0, 0);
                this.ctx.restore();

                // Pieces
                pieces.forEach(piece => {
                    const zone = zones.find(z => z.id === piece.id && z.placed);
                    const isSelected = (piece.id === selectedPieceId);
                    if (zone) {
                        this.drawPiece({ ...piece,
                            ...zone
                        }, isSelected);
                    } else {
                        this.drawPiece(piece, isSelected);
                    }
                });

                // Guide
                if (selectedPieceId) {
                    const zone = zones.find(z => z.id === selectedPieceId);
                    if (zone && !zone.placed) {
                        this.drawGuide(zone);
                    }
                }

                // Placed labels
                this.drawPlacedLabels(completed);

                // Feedback
                const feedbackY = this.frame.y + this.totalSize + 40;
                if (completed) {
                    this.drawFeedback("Hence Proved: (a+b+c)² = a²+b²+c²+2ab+2ac+2bc", '#4CAF50', feedbackY);
                    currentStepText.textContent = "Congratulations! Puzzle complete.";
                } else if (feedback.message) {
                    this.drawFeedback(feedback.message, feedback.color, feedbackY);
                }
            }

            drawPlacedLabels(forceAll = false) {
                const {
                    zones
                } = this.state;
                this.ctx.fillStyle = 'black';
                this.ctx.font = `bold 20px ${this.fontSans}`;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                const drawLabel = (text, x, y, rotation = 0) => {
                    this.ctx.save();
                    this.ctx.translate(x, y);
                    this.ctx.rotate(rotation);
                    this.ctx.fillText(text, 0, 0);
                    this.ctx.restore();
                };

                // Top labels
                if (forceAll || zones.find(z => z.id === 'a_sq').placed) {
                    drawLabel('a', this.frame.x + this.a / 2, this.frame.y - 10);
                }
                if (forceAll || zones.find(z => z.id === 'ab_1').placed) {
                    drawLabel('b', this.frame.x + this.a + this.b / 2, this.frame.y - 10);
                }
                if (forceAll || zones.find(z => z.id === 'ac_1').placed) {
                    drawLabel('c', this.frame.x + this.a + this.b + this.c / 2, this.frame.y - 10);
                }

                // Left labels
                if (forceAll || zones.find(z => z.id === 'a_sq').placed) {
                    drawLabel('a', this.frame.x - 10, this.frame.y + this.a / 2, -Math.PI / 2);
                }
                if (forceAll || zones.find(z => z.id === 'ab_2').placed) {
                    drawLabel('b', this.frame.x - 10, this.frame.y + this.a + this.b / 2, -Math.PI / 2);
                }
                if (forceAll || zones.find(z => z.id === 'ac_2').placed) {
                    drawLabel('c', this.frame.x - 10, this.frame.y + this.a + this.b + this.c / 2, -Math.PI / 2);
                }

                // Draw outer labels only if forced (i.e., completed)
                if (forceAll) {
                    // Right labels
                    drawLabel('a', this.frame.x + this.totalSize + 10, this.frame.y + this.a / 2, -Math.PI / 2);
                    drawLabel('b', this.frame.x + this.totalSize + 10, this.frame.y + this.a + this.b / 2, -Math.PI / 2);
                    drawLabel('c', this.frame.x + this.totalSize + 10, this.frame.y + this.a + this.b + this.c / 2, -Math.PI / 2);
                    // Bottom labels
                    drawLabel('a', this.frame.x + this.a / 2, this.frame.y + this.totalSize + 10);
                    drawLabel('b', this.frame.x + this.a + this.b / 2, this.frame.y + this.totalSize + 10);
                    drawLabel('c', this.frame.x + this.a + this.b + this.c / 2, this.frame.y + this.totalSize + 10);
                }
            }

            onCanvasClick(x, y) {
                const {
                    pieces,
                    zones,
                    selectedPieceId
                } = this.state;
                if (this.state.completed) return;
                let pieceClicked = false;
                let feedbackMsg = "";
                let feedbackColor = '#333333';

                // 1. Check if a piece in the bank was clicked
                for (const piece of pieces) {
                    const isPlaced = zones.find(z => z.id === piece.id && z.placed);
                    if (!isPlaced && isPointInRect({
                            x,
                            y
                        }, piece, this.clickTolerance)) {
                        this.state.selectedPieceId = piece.id;
                        feedbackMsg = `"${piece.label}" selected. Now click where it goes in the frame.`;
                        currentStepText.textContent = `Click the empty space where the "${piece.label}" piece should go.`;
                        pieceClicked = true;
                        break;
                    }
                }

                // 2. If a piece is selected, check if a zone was clicked
                if (!pieceClicked && selectedPieceId) {
                    const targetZone = zones.find(z => z.id === selectedPieceId);

                    if (targetZone && !targetZone.placed && isPointInRect({
                            x,
                            y
                        }, targetZone, this.clickTolerance)) {
                        targetZone.placed = true;
                        this.state.selectedPieceId = null;
                        feedbackMsg = "Correct! Well done!";
                        feedbackColor = '#4CAF50';
                        currentStepText.textContent = "Excellent! Now select another piece from the right.";

                        if (zones.every(z => z.placed)) {
                            this.state.completed = true;
                        }
                    } else {
                        // Clicked somewhere, but not the correct zone
                        let clickedWrongZone = false;
                        for (const zone of zones) {
                            if (!zone.placed && isPointInRect({
                                    x,
                                    y
                                }, zone, this.clickTolerance)) {
                                clickedWrongZone = true;
                                break;
                            }
                        }
                        if (clickedWrongZone) {
                            feedbackMsg = "That piece doesn't fit here. Try again.";
                            feedbackColor = '#F44336';
                            currentStepText.textContent = `Oops! The selected piece doesn't go there. Click the correct space.`;
                        } else {
                            feedbackMsg = "Click the highlighted space in the frame to place the piece.";
                            currentStepText.textContent = `Click the highlighted space in the frame to place the selected piece.`;
                        }
                    }
                } else if (!pieceClicked && !selectedPieceId) {
                    feedbackMsg = "Please click a piece from the right side first.";
                    currentStepText.textContent = "Click a piece on the right to select it.";
                }

                this.state.feedback = {
                    message: feedbackMsg,
                    color: feedbackColor
                };
                this.draw();
            }
        }
    </script>
</body>

</html>
